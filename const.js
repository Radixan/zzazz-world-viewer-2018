MAP_PTR = 0xB800 - 5; // Checksum
MAP_NAMES = {
    0x0000: "MYSTERY ZONE",
    0x0001: "TestMap2",
    0x0110: "CENTRAL SQUARE",
    0x0210: "NORTHERN PASSAGE",
    0x0327: "GLITCHED HOUSE",
    0x0364: "GLITCHED HOUSE",
    0x043A: "TOO MUCH WATER",
    0x0523: "NORTHERN PASSAGE",
    0x0565: "GLITCHLAND LAB",
    0x0566: "GLITCHLAND LAB",
    0x062F: "NORTHERN RETREAT",
    0x0667: "NORTHERN RETREAT",
    0x0668: "NORTHERN RETREAT",
    0x0669: "NORTHERN RETREAT",
    0x066A: "GLITCHOLOGY MUSEUM",
    0x0734: "CROSSROADS",
    0x0824: "SHIFTING GROVE",
    0x0932: "WORRIED EXPLORER",
    0x096B: "WORRIED EXPLORER",
    0x098A: "UNDERGROUND",
    0x0A32: "STRANGE BUSH",
    0x0B2D: "STRANGE PILLAR",
    0x0C2C: "STRANGE SIGN",
    0x0D3E: "SHIMMERING PASS",
    0x0E3C: "THE TRENDSETTERS",
    0x0E6C: "THE TRENDSETTERS",
    0x0F3B: "BOARDWALK",
    0x103B: "THE WISE MAN",
    0x106D: "THE WISE MAN",
    0x113D: "THE HARBOR",
    0x116E: "HARBOR HOUSE",
    0x123D: "UNKNOWN HOUSE",
    0x1321: "SEABORGIUM SEA",
    0x1337: "MYSTERIOUS",
    0x1432: "SHADY MERCHANT",
    0x146F: "SHADY MERCHANT",
    0x152D: "WORLD 4-4",
    0x1631: "NORTHERN CAMP",
    0x1670: "NORTHERN CAMP",
    0x1671: "NORTHERN CAMP",
    0x1672: "NORTHERN CAMP",
    0x1720: "ROAD OF ULTIMATE",
    0x1730: "ALTERING CAVE",
    0x1731: "ALTERING CAVE",
    0x1732: "ALTERING CAVE",
    0x182A: "WHO'S THAT POKéMON",
    0x1927: "NORTHERN EDGE",
    0x1A3C: "GAME CORNER",
    0x1A73: "GAME CORNER",
    0x1B37: "WESTERN PASSAGE",
    0x1C2C: "CROSSING FIELD",
    0x1D3B: "WINDY VALLEY",
    0x1E33: "GUARD POST",
    0x1E92: "TINY CAVERN",
    0x1F3A: "DELIRIA",
    0x1F79: "DELIRIA",
    0x1F7A: "DELIRIA",
    0x202F: "DELIRIA POND",
    0x207B: "DELIRIA",
    0x2125: "BIKE SHOP",
    0x2174: "BIKE SHOP",
    0x223A: "MANSION ENTRANCE",
    0x2275: "GLITCHLAND MANSION",
    0x2276: "GLITCHLAND MANSION",
    0x2277: "GLITCHLAND MANSION",
    0x232D: "PATH OF POINTLESS",
    0x2435: "???",
    0x2478: "DESOLATED CABIN",
    0x2536: "CABIN FRONTYARD",
    0x2632: "LOOKOUT POINT",
    0x2725: "DARK CAVE",
    0x2731: "DARK CAVE",
    0x2791: "DARK CAVE",
    0x2B29: "WESTERN ENCAMPMENT",
    0x2B7C: "WESTERN ENCAMPMENT",
    0x2B7D: "WESTERN ENCAMPMENT",
    0x2B7E: "EXPLORER SINDICATE",
    0x2C29: "ROUTE 13.5",
    0x2D27: "WESTERN EDGE",
    0x2E2B: "EASTERN PASSAGE",
    0x2F38: "EASTERN ENCAMPMENT",
    0x2F7F: "EASTERN ENCAMPMENT",
    0x2F80: "EASTERN ENCAMPMENT",
    0x2F81: "EASTERN ENCAMPMENT",
    0x302C: "PATH OF RECURSION",
    0x3120: "CRACKER CAVERN",
    0x318B: "CRACKER CAVERN I",
    0x318C: "CRACKER CAVERN II",
    0x318D: "CRACKER CAVERN III",
    0x318E: "CRACKER CAVERN IV",
    0x318F: "CRACKER CAVERN V",
    0x323F: "OBSCURED PATH",
    0x3336: "DOWNHILL ROAD",
    0x3420: "THE BLING PARK",
    0x3828: "CORRUPTED PLAINS",
    0x3920: "EASTERN AVENUE",
    0x3A3E: "GRASSLANDS",
    0x3B22: "LOST WOODS",
    0x3B30: "LOST WOODS A",
    0x3B31: "LOST WOODS B",
    0x3B32: "LOST WOODS C",
    0x3C36: "EASTERN EDGE",
    0x3D20: "THE GREAT DESIGNER",
    0x3D83: "DESIGNER'S HOUSE",
    0x3E31: "DESIGNER CREATION",
    0x3E90: "DESIGNER'S CAVE",
    0x3F3D: "SOUTHERN PASSAGE",
    0x4026: "BROKEN BRIDGE",
    0x412E: "FRAGNANT FIELDS",
    0x423A: "BRIDGE OF HOPES",
    0x432A: "GLITCHLAND LIBRARY",
    0x4384: "GLITCHLAND LIBRARY",
    0x4528: "BINARY WOODS",
    0x4530: "BINARY WOODS",
    0x4585: "BINARY WOODS",
    0x472B: "SOUTHERN CAMP",
    0x4786: "SOUTHERN CAMP",
    0x4787: "SOUTHERN CAMP",
    0x4788: "SOUTHERN CAMP",
    0x482B: "TEAM ROCKET HQ",
    0x4889: "TEAM ROCKET HQ",
    0x4933: "JUMPITY JUMP",
    0x4A34: "YET ANOTHER ROUTE",
    0x4B3A: "HIDDEN RETREAT",
    0x4C21: "YET ANOTHER CAVE",
    0x4C93: "YET ANOTHER CAVE",
    0x4D3A: "YET ANOTHER PATH",
    0x4E22: "YET ANOTHER SECRET",
    0x4F21: "SOUTHERN EDGE"
}

CHARSET_ASCII = {};
{
  let ascii_str = "_ABCDEFGHIJKLMNOPQRSTUVWXYZ" +
                  "abcdefghijklmnopqrstuvwxyz!" +
                  ",?\"-.:() \u2003$'/0123456789\u00E9";
  for(let i = 0; i < ascii_str.length; ++i) CHARSET_ASCII[i] = ascii_str[i];
  CHARSET_ASCII[0xA8] = '\u00E1'; // á  That's
  CHARSET_ASCII[0xA9] = '\u00F3'; // ó    dedication!
}

PALETTES = [[0x7FBF, 0x2F95, 0x7F54, 0x0843],
            [0x7FBF, 0x6F99, 0x7F54, 0x0843],
            [0x7FBF, 0x0F51, 0x7F54, 0x0843],
            [0x7FBF, 0x4337, 0x7F54, 0x0843],
            [0x7FBF, 0x7A91, 0x7F54, 0x0843],
            [0x7FBF, 0x6E9B, 0x7F54, 0x0843],
            [0x7FBF, 0x025E, 0x7F54, 0x0843],
            [0x7FBF, 0x5BD0, 0x7F54, 0x0843],
            [0x7FBF, 0x59FF, 0x7F54, 0x0843],
            [0x7FBF, 0x195A, 0x7F54, 0x0843],
            [0x7FBF, 0x61D6, 0x7F54, 0x0843],
            [0x7FBF, 0x0F7B, 0x7F54, 0x0843]];

CAVE_PALETTE = [0x7FBF, 0x25D5, 0x5B12, 0x0843];

for(let i = 0; i < PALETTES.length; ++i) {
   let p = PALETTES[i];
   for(let j = 0; j < p.length; ++j) {
      let c = p[j];
      p[j] = [(c & 0x1F) << 3, ((c >> 5) & 0x1F) << 3, ((c >> 10) & 0x1F) << 3];
      p[j][0] |= p[j][0] >> 5;
      p[j][1] |= p[j][1] >> 5;
      p[j][2] |= p[j][2] >> 5;
   }
}
for(let j = 0; j < CAVE_PALETTE.length; ++j) {
   let c = CAVE_PALETTE[j];
   CAVE_PALETTE[j] = [(c & 0x1F) << 3, ((c >> 5) & 0x1F) << 3, ((c >> 10) & 0x1F) << 3];
   CAVE_PALETTE[j][0] |= CAVE_PALETTE[j][0] >> 5;
   CAVE_PALETTE[j][1] |= CAVE_PALETTE[j][1] >> 5;
   CAVE_PALETTE[j][2] |= CAVE_PALETTE[j][2] >> 5;
}

TILE_SIZE = 0x10;
BLOCK_SIZE = TILE_SIZE + TILE_SIZE;
PIXEL_SIZE = 0x4;
ROW_SIZE = BLOCK_SIZE * PIXEL_SIZE;
TEXTURE_SIZE = PIXEL_SIZE * BLOCK_SIZE;
BX = 0x3;
BY = 0x2;

const WALK_DIRECTION = Object.freeze({
  0xD0 : 'Down',
  0xD1 : 'Up',
  0xD2 : 'Left',
  0xD3 : 'Right',
  0x01 : 'Up-Down',
  0x02 : 'Left-Right',
  0x00 : 'All',
  0xFF : 'None'
})

const DIRECTION = Object.freeze([
  'North',
  'South',
  'West',
  'East'
])

const FONT = Object.freeze({
  0x8D: 'Braile',
  0x4D: 'Deliria'
})

const EVENT = Object.freeze({
  TEXT: 'TEXT',
  PARA: 'PARA',
  NEXT: 'NEXT',
  CONT: 'CONT',
  WAIT: 'WAIT',
  BUF: 'BUF',
  BUF_END: 'BUF_END',
  FONT: 'FONT',
  SND: 'SND',
  ASM: 'ASM',
  TAG: 'TAG'
})

GLOBAL_POS = {
  0x0110: [0, 0],
  0x0210: [64, -640],
  0x0327: [-384, -544],
  0x0364: [-320, -800],
  0x043A: [-960, -608],
  0x0523: [64, -1056],
  0x0565: [736, -1056],
  0x0566: [736, -736],
  0x062F: [192, -1632],
  0x0667: [704, -1312],
  0x0668: [-128, -1376],
  0x0669: [-128, -1632],
  0x066A: [1024, -1536],
  0x0734: [352, -1984],
  0x0824: [-224, -2016],
  0x0932: [-640, -2080],
  0x096B: [-960, -2208],
  0x098A: [-1344, -2112],
  0x0A32: [-640, -1632],
  0x0B2D: [-640, -2368],
  0x0C2C: [-992, -1952],
  0x0D3E: [768, -2048],
  0x0E3C: [1440, -1888],
  0x0E6C: [1504, -2144],
  0x0F3B: [1536, -1504],
  0x103B: [1536, -960],
  0x106D: [1536, -640],
  0x113D: [1888, -2112],
  0x116E: [2176, -1600],
  0x123D: [2528, -1952],
  0x1321: [1952, -2592],
  0x1432: [1504, -2592],
  0x146F: [1760, -2816],
  0x152D: [992, -2784],
  0x1631: [832, -3232],
  0x1670: [928, -3488],
  0x1671: [1440, -2976],
  0x1672: [512, -2944],
  0x1720: [1376, -3328],
  0x1730: [1376, -3680],
  0x1731: [1376, -4032],
  0x1732: [1376, -4384],
  0x182A: [2208, -3584],
  0x1927: [2272, -3872],
  0x1A3C: [448, -3232],
  0x1A73: [448, -3520],
  0x1B37: [-672, -64],
  0x1C2C: [-1088, 32],
  0x1D3B: [-1088, 384],
  0x1E33: [-1088, 928],
  0x1E92: [-1152, 1408],
  0x1F3A: [-512, 928],
  0x1F79: [-288, 768],
  0x1F7A: [-512, 1376],
  0x202F: [0, 960],
  0x2125: [-672, 512],
  0x2174: [-288, 512],
  0x223A: [-1536, 480],
  0x2275: [-2560, 320],
  0x2276: [-3136, 320],
  0x2277: [-3584, 320],
  0x232D: [-1440, 800],
  0x2435: [-1952, 896],
  0x2478: [-2303, 1152],
  0x2536: [-1920, 1280],
  0x2632: [-2336, 864],
  0x2725: [-1216, -384],
  0x2731: [-2112, -384],
  0x2791: [-1952, -992],
  0x2B29: [-2624, -256],
  0x2B7C: [-2592, -800],
  0x2B7D: [-2272, -800],
  0x2B7E: [-2592, -544],
  0x2C29: [-3296, -224],
  0x2D27: [-3648, -128],
  0x2E2B: [512, 96],
  0x2F38: [1024, 320],
  0x2F7F: [927, -191],
  0x2F80: [1247, -191],
  0x2F81: [1184, 65],
  0x302C: [1536, 384],
  0x3120: [1568, -32],
  0x318B: [1984, -32],
  0x318C: [1984, -352],
  0x318D: [1984, -672],
  0x318E: [1984, -992],
  0x318F: [1984, -1312],
  0x323F: [1568, 736],
  0x3336: [1056, 704],
  0x3420: [1056, 1280],
  0x353C: [672, 1280],
  0x3621: [448, 1632],
  0x3724: [416, 960],
  0x3828: [1568, 1312],
  0x3920: [1024, 1632],
  0x3A3E: [1536, 1696],
  0x3B22: [2176, 1696],
  0x3B30: [2176, 1344],
  0x3B31: [2592, 1344],
  0x3B32: [3008, 1344],
  0x3C36: [2592, 1760],
  0x3D20: [1024, 2112],
  0x3D83: [1056, 2464],
  0x3E31: [-64, 2176],
  0x3E90: [320, 1856],
  0x3F3D: [0, 3008],
  0x4026: [-544, 3136],
  0x412E: [-1184, 3104],
  0x423A: [64, 3584],
  0x432A: [544, 3648],
  0x4384: [608, 3360],
  0x4528: [-608, 4416],
  0x4530: [64, 4032],
  0x4585: [-640, 3776],
  0x472B: [96, 4448],
  0x4786: [576, 4000],
  0x4787: [576, 4256],
  0x4788: [896, 4256],
  0x482B: [96, 4928],
  0x4889: [128, 5216],
  0x4933: [-2016, 128],
  0x4A34: [576, 4512],
  0x4B3A: [1120, 4512],
  0x4C21: [736, 4992],
  0x4C93: [800, 5408],
  0x4D3A: [1280, 5120],
  0x4E22: [1728, 5120],
  0x4F21: [1344, 5696]
}

TILESET_NAMES = {
  0x00: "OVERWORLD",
  0x03: "FOREST",
  0x04: "RED HOUSE",
  0x05: "GYM",
  0x08: "HOUSE",
  0x09: "MUSEUM",
  0x10: "SILPH CO.",
  0x11: "CAVE",
  0x12: "MART",
  0x13: "STUDIO",
  0x15: "BIKE SHOP",
  0x16: "MANSION"
}

SPRITE_NAMES = {
  0x01: "RED",
  0x02: "BLUE",
  0x03: "OAK",
  0x04: "BUG_CATCHER",
  0x05: "SLOWBRO",
  0x06: "LASS",
  0x07: "BLACK_HAIR_BOY_1",
  0x08: "LITTLE_GIRL",
  0x09: "BIRD",
  0x0A: "FAT_BALD_GUY",
  0x0B: "GAMBLER",
  0x0C: "BLACK_HAIR_BOY_2",
  0x0D: "GIRL",
  0x0E: "HIKER",
  0x0F: "FOULARD_WOMAN",
  0x10: "GENTLEMAN",
  0x11: "DAISY",
  0x12: "BIKER",
  0x13: "SAILOR",
  0x14: "COOK",
  0x15: "BIKE_SHOP_GUY",
  0x16: "MR_FUJI",
  0x17: "GIOVANNI",
  0x18: "ROCKET",
  0x19: "MEDIUM",
  0x1A: "WAITER",
  0x1B: "ERIKA",
  0x1C: "MOM_GEISHA",
  0x1D: "BRUNETTE_GIRL",
  0x1E: "LANCE",
  0x1F: "OAK_SCIENTIST_AIDE",
  0x20: "OAK_AIDE",
  0x21: "ROCKER",
  0x22: "SWIMMER",
  0x23: "WHITE_PLAYER",
  0x24: "GYM_HELPER",
  0x25: "OLD_PERSON",
  0x26: "MART_GUY",
  0x27: "FISHER",
  0x28: "OLD_MEDIUM_WOMAN",
  0x29: "NURSE",
  0x2A: "CABLE_CLUB_WOMAN",
  0x2B: "MR_MASTERBALL",
  0x2C: "LAPRAS_GIVER",
  0x2D: "WARDEN",
  0x2E: "SS_CAPTAIN",
  0x2F: "FISHER2",
  0x30: "BLACKBELT",
  0x31: "GUARD",
  0x32: "COP_GUARD",
  0x33: "MOM",
  0x34: "BALDING_GUY",
  0x35: "YOUNG_BOY",
  0x36: "GAMEBOY_KID",
  0x37: "GAMEBOY_KID_COPY",
  0x38: "CLEFAIRY",
  0x39: "AGATHA",
  0x3A: "BRUNO",
  0x3B: "LORELEI",
  0x3C: "SEEL",
  0x3D: "BALL",
  0x3E: "OMANYTE",
  0x3F: "BOULDER",
  0x40: "PAPER_SHEET",
  0x41: "BOOK_MAP_DEX",
  0x42: "CLIPBOARD",
  0x43: "SNORLAX",
  0x44: "OLD_AMBER_COPY",
  0x45: "OLD_AMBER",
  0x46: "LYING_OLD_MAN_UNUSED_1",
  0x47: "LYING_OLD_MAN_UNUSED_2",
  0x48: "LYING_OLD_MAN"
}

const _CheckEventAndPrintHLIfCompleted = 0xB2EE;
const _CheckItemAndPrintHLIfCompleted = 0xB2FB;
const _CheckEventAndQuitIfCompleted = 0xB2CC;
const _PrintTextEnhanced = 0xDB9F;
const _EnhancedTextOnly = 0xDC4E;
